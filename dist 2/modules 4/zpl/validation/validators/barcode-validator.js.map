{"version":3,"sources":["../../../../../src/modules/zpl/validation/validators/barcode-validator.ts"],"sourcesContent":["import {\n  IZplValidator,\n  ValidatorType,\n  ValidationIssue,\n  ValidationOptions,\n} from '../zpl-validation.types.js';\nimport { getMessages } from '../messages/error-messages.js';\n\n/**\n * Validador de codigos de barras ZPL\n * Verifica: Tipos soportados, orientacion, modelo QR, datos vacios\n */\nexport class BarcodeValidator implements IZplValidator {\n  type: ValidatorType = 'barcode';\n\n  // Comandos de codigo de barras soportados por Labelary\n  private readonly supportedBarcodes = [\n    '^B1', // Code 11\n    '^B2', // Interleaved 2 of 5\n    '^B3', // Code 39\n    '^B7', // PDF417\n    '^B8', // EAN-8\n    '^B9', // UPC-E\n    '^BA', // EAN-13 (alias)\n    '^BB', // CODABLOCK\n    '^BC', // Code 128\n    '^BD', // UPS MaxiCode\n    '^BE', // EAN-13\n    '^BF', // Micro-PDF417\n    '^BI', // Industrial 2 of 5\n    '^BJ', // Standard 2 of 5\n    '^BK', // ANSI Codabar\n    '^BL', // LOGMARS\n    '^BM', // MSI\n    '^BO', // Aztec\n    '^BP', // Plessey\n    '^BQ', // QR Code\n    '^BR', // RSS/GS1 DataBar\n    '^BS', // UPC/EAN Extensions\n    '^BU', // UPC-A\n    '^BX', // Data Matrix\n    '^BY', // Bar Code Field Default\n    '^BZ', // POSTAL\n  ];\n\n  // Orientaciones validas\n  private readonly validOrientations = ['N', 'R', 'I', 'B', ''];\n\n  validate(block: string, options: ValidationOptions): ValidationIssue[] {\n    const issues: ValidationIssue[] = [];\n    const messages = getMessages(options.language);\n\n    // Buscar todos los comandos de codigo de barras\n    const barcodePattern = /\\^B([0-9A-Z])([^^\\n]*)?/g;\n    let match;\n\n    while ((match = barcodePattern.exec(block)) !== null) {\n      const command = '^B' + match[1];\n      const params = match[2] || '';\n\n      // Verificar si el tipo de codigo de barras es soportado\n      if (!this.supportedBarcodes.includes(command)) {\n        issues.push({\n          code: 'ZPL_BC_001',\n          type: this.type,\n          severity: 'error',\n          message: messages.unsupportedBarcode(command),\n          position: match.index,\n          context: match[0].substring(0, 30),\n          suggestion: messages.suggestSupportedBarcodes,\n          command,\n        });\n        continue;\n      }\n\n      // Validaciones especificas por tipo\n      switch (command) {\n        case '^BC': // Code 128\n          this.validateCode128(params, match.index, issues, messages);\n          break;\n        case '^BQ': // QR Code\n          this.validateQRCode(params, match.index, issues, messages);\n          break;\n        case '^BY': // Bar Code Field Default\n          this.validateBYDefault(params, match.index, issues, messages);\n          break;\n      }\n    }\n\n    // Verificar que los codigos de barras tengan datos\n    this.validateBarcodeData(block, issues, messages);\n\n    return issues;\n  }\n\n  private validateCode128(\n    params: string,\n    position: number,\n    issues: ValidationIssue[],\n    messages: ReturnType<typeof getMessages>,\n  ): void {\n    // ^BCo,h,f,g,e,m - verificar orientacion valida\n    const parts = params.split(',');\n    const orientation = parts[0]?.trim();\n\n    if (orientation && !this.validOrientations.includes(orientation)) {\n      issues.push({\n        code: 'ZPL_BC_002',\n        type: this.type,\n        severity: 'error',\n        message: messages.invalidOrientation(orientation),\n        position,\n        suggestion: messages.suggestOrientations,\n        command: '^BC',\n      });\n    }\n  }\n\n  private validateQRCode(\n    params: string,\n    position: number,\n    issues: ValidationIssue[],\n    messages: ReturnType<typeof getMessages>,\n  ): void {\n    // ^BQa,b,c - a=orientation, b=model, c=magnification\n    const parts = params.split(',');\n\n    // Verificar orientacion\n    const orientation = parts[0]?.trim();\n    if (orientation && !this.validOrientations.includes(orientation)) {\n      issues.push({\n        code: 'ZPL_BC_002',\n        type: this.type,\n        severity: 'error',\n        message: messages.invalidOrientation(orientation),\n        position,\n        suggestion: messages.suggestOrientations,\n        command: '^BQ',\n      });\n    }\n\n    // Verificar modelo (debe ser 1 o 2)\n    const model = parts[1]?.trim();\n    if (model && !['1', '2'].includes(model)) {\n      issues.push({\n        code: 'ZPL_BC_003',\n        type: this.type,\n        severity: 'warning',\n        message: messages.invalidQRModel,\n        position,\n        suggestion: messages.suggestQRModels,\n        command: '^BQ',\n      });\n    }\n  }\n\n  private validateBYDefault(\n    params: string,\n    position: number,\n    issues: ValidationIssue[],\n    messages: ReturnType<typeof getMessages>,\n  ): void {\n    // ^BYw,r,h - w=module width, r=ratio, h=height\n    const parts = params.split(',');\n    const width = parts[0]?.trim();\n\n    if (width) {\n      const widthNum = parseInt(width, 10);\n      if (!isNaN(widthNum) && (widthNum < 1 || widthNum > 10)) {\n        issues.push({\n          code: 'ZPL_BC_004',\n          type: this.type,\n          severity: 'warning',\n          message: messages.invalidBarWidth,\n          position,\n          suggestion: messages.suggestBarWidth,\n          command: '^BY',\n        });\n      }\n    }\n  }\n\n  private validateBarcodeData(\n    block: string,\n    issues: ValidationIssue[],\n    messages: ReturnType<typeof getMessages>,\n  ): void {\n    // Buscar comandos de barcode seguidos de ^FD vacio\n    // Patron: ^B[tipo][params]^FD^FS (sin datos entre ^FD y ^FS)\n    const barcodeWithEmptyData = /\\^B[0-9A-Z][^^\\n]*\\^FD\\s*\\^FS/g;\n    let match;\n\n    while ((match = barcodeWithEmptyData.exec(block)) !== null) {\n      issues.push({\n        code: 'ZPL_BC_005',\n        type: this.type,\n        severity: 'error',\n        message: messages.emptyBarcodeData,\n        position: match.index,\n        context: match[0].substring(0, 40),\n        suggestion: messages.suggestAddBarcodeData,\n      });\n    }\n  }\n}\n"],"names":["getMessages","BarcodeValidator","validate","block","options","issues","messages","language","barcodePattern","match","exec","command","params","supportedBarcodes","includes","push","code","type","severity","message","unsupportedBarcode","position","index","context","substring","suggestion","suggestSupportedBarcodes","validateCode128","validateQRCode","validateBYDefault","validateBarcodeData","parts","split","orientation","trim","validOrientations","invalidOrientation","suggestOrientations","model","invalidQRModel","suggestQRModels","width","widthNum","parseInt","isNaN","invalidBarWidth","suggestBarWidth","barcodeWithEmptyData","emptyBarcodeData","suggestAddBarcodeData"],"mappings":"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"}