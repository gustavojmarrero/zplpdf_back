{"version":3,"sources":["../../../../../src/modules/zpl/validation/validators/field-validator.ts"],"sourcesContent":["import {\n  IZplValidator,\n  ValidatorType,\n  ValidationIssue,\n  ValidationOptions,\n} from '../zpl-validation.types.js';\nimport { getMessages } from '../messages/error-messages.js';\n\n/**\n * Validador de campos ZPL\n * Verifica: Balance ^FD/^FS, campos vacios, ^FD sin posicion previa\n */\nexport class FieldValidator implements IZplValidator {\n  type: ValidatorType = 'field';\n\n  validate(block: string, options: ValidationOptions): ValidationIssue[] {\n    const issues: ValidationIssue[] = [];\n    const messages = getMessages(options.language);\n\n    // Contar ^FD y ^FS\n    const fdMatches = block.match(/\\^FD/g) || [];\n    const fsMatches = block.match(/\\^FS/g) || [];\n\n    // Verificar balance\n    if (fdMatches.length !== fsMatches.length) {\n      issues.push({\n        code: 'ZPL_FIELD_001',\n        type: this.type,\n        severity: 'error',\n        message: messages.fdFsImbalance(fdMatches.length, fsMatches.length),\n        suggestion: messages.suggestCheckFdFs,\n      });\n    }\n\n    // Verificar ^FD vacios (^FD seguido inmediatamente de ^FS)\n    const emptyFdPattern = /\\^FD\\s*\\^FS/g;\n    let match;\n    while ((match = emptyFdPattern.exec(block)) !== null) {\n      issues.push({\n        code: 'ZPL_FIELD_002',\n        type: this.type,\n        severity: 'warning',\n        message: messages.emptyFd,\n        position: match.index,\n        context: match[0],\n        suggestion: messages.suggestRemoveEmptyFd,\n        command: '^FD',\n      });\n    }\n\n    // Verificar ^FD sin ^FO/^FT previo\n    const fdPositions = this.findAllPositions(block, /\\^FD/g);\n    const positionCommands = this.findAllPositions(block, /\\^F[OT]/g);\n\n    for (const fdPos of fdPositions) {\n      // Buscar si hay un comando de posicion antes de este ^FD\n      // y que no haya otro ^FD entre ellos\n      const hasPriorPosition = positionCommands.some((pos) => {\n        if (pos >= fdPos) return false;\n        // Verificar que no hay otro ^FD entre el ^FO/^FT y este ^FD\n        const betweenFds = fdPositions.filter((p) => p > pos && p < fdPos);\n        return betweenFds.length === 0;\n      });\n\n      if (!hasPriorPosition && fdPos > 10) {\n        // Ignorar si ^FD esta al inicio\n        issues.push({\n          code: 'ZPL_FIELD_003',\n          type: this.type,\n          severity: 'warning',\n          message: messages.fdWithoutPosition,\n          position: fdPos,\n          suggestion: messages.suggestAddPosition,\n          command: '^FD',\n        });\n      }\n    }\n\n    return issues;\n  }\n\n  private findAllPositions(str: string, regex: RegExp): number[] {\n    const positions: number[] = [];\n    let match;\n    const re = new RegExp(regex.source, 'g');\n    while ((match = re.exec(str)) !== null) {\n      positions.push(match.index);\n    }\n    return positions;\n  }\n}\n"],"names":["getMessages","FieldValidator","validate","block","options","issues","messages","language","fdMatches","match","fsMatches","length","push","code","type","severity","message","fdFsImbalance","suggestion","suggestCheckFdFs","emptyFdPattern","exec","emptyFd","position","index","context","suggestRemoveEmptyFd","command","fdPositions","findAllPositions","positionCommands","fdPos","hasPriorPosition","some","pos","betweenFds","filter","p","fdWithoutPosition","suggestAddPosition","str","regex","positions","re","RegExp","source"],"mappings":"AAMA,SAASA,WAAW,QAAQ,gCAAgC;AAE5D;;;CAGC,GACD,OAAO,MAAMC;IAGXC,SAASC,KAAa,EAAEC,OAA0B,EAAqB;QACrE,MAAMC,SAA4B,EAAE;QACpC,MAAMC,WAAWN,YAAYI,QAAQG,QAAQ;QAE7C,mBAAmB;QACnB,MAAMC,YAAYL,MAAMM,KAAK,CAAC,YAAY,EAAE;QAC5C,MAAMC,YAAYP,MAAMM,KAAK,CAAC,YAAY,EAAE;QAE5C,oBAAoB;QACpB,IAAID,UAAUG,MAAM,KAAKD,UAAUC,MAAM,EAAE;YACzCN,OAAOO,IAAI,CAAC;gBACVC,MAAM;gBACNC,MAAM,IAAI,CAACA,IAAI;gBACfC,UAAU;gBACVC,SAASV,SAASW,aAAa,CAACT,UAAUG,MAAM,EAAED,UAAUC,MAAM;gBAClEO,YAAYZ,SAASa,gBAAgB;YACvC;QACF;QAEA,2DAA2D;QAC3D,MAAMC,iBAAiB;QACvB,IAAIX;QACJ,MAAO,AAACA,CAAAA,QAAQW,eAAeC,IAAI,CAAClB,MAAK,MAAO,KAAM;YACpDE,OAAOO,IAAI,CAAC;gBACVC,MAAM;gBACNC,MAAM,IAAI,CAACA,IAAI;gBACfC,UAAU;gBACVC,SAASV,SAASgB,OAAO;gBACzBC,UAAUd,MAAMe,KAAK;gBACrBC,SAAShB,KAAK,CAAC,EAAE;gBACjBS,YAAYZ,SAASoB,oBAAoB;gBACzCC,SAAS;YACX;QACF;QAEA,mCAAmC;QACnC,MAAMC,cAAc,IAAI,CAACC,gBAAgB,CAAC1B,OAAO;QACjD,MAAM2B,mBAAmB,IAAI,CAACD,gBAAgB,CAAC1B,OAAO;QAEtD,KAAK,MAAM4B,SAASH,YAAa;YAC/B,yDAAyD;YACzD,qCAAqC;YACrC,MAAMI,mBAAmBF,iBAAiBG,IAAI,CAAC,CAACC;gBAC9C,IAAIA,OAAOH,OAAO,OAAO;gBACzB,4DAA4D;gBAC5D,MAAMI,aAAaP,YAAYQ,MAAM,CAAC,CAACC,IAAMA,IAAIH,OAAOG,IAAIN;gBAC5D,OAAOI,WAAWxB,MAAM,KAAK;YAC/B;YAEA,IAAI,CAACqB,oBAAoBD,QAAQ,IAAI;gBACnC,gCAAgC;gBAChC1B,OAAOO,IAAI,CAAC;oBACVC,MAAM;oBACNC,MAAM,IAAI,CAACA,IAAI;oBACfC,UAAU;oBACVC,SAASV,SAASgC,iBAAiB;oBACnCf,UAAUQ;oBACVb,YAAYZ,SAASiC,kBAAkB;oBACvCZ,SAAS;gBACX;YACF;QACF;QAEA,OAAOtB;IACT;IAEQwB,iBAAiBW,GAAW,EAAEC,KAAa,EAAY;QAC7D,MAAMC,YAAsB,EAAE;QAC9B,IAAIjC;QACJ,MAAMkC,KAAK,IAAIC,OAAOH,MAAMI,MAAM,EAAE;QACpC,MAAO,AAACpC,CAAAA,QAAQkC,GAAGtB,IAAI,CAACmB,IAAG,MAAO,KAAM;YACtCE,UAAU9B,IAAI,CAACH,MAAMe,KAAK;QAC5B;QACA,OAAOkB;IACT;;aA5EA5B,OAAsB;;AA6ExB"}