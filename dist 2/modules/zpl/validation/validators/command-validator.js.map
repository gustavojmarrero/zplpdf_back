{"version":3,"sources":["../../../../../src/modules/zpl/validation/validators/command-validator.ts"],"sourcesContent":["import {\n  IZplValidator,\n  ValidatorType,\n  ValidationIssue,\n  ValidationOptions,\n} from '../zpl-validation.types.js';\nimport { getMessages } from '../messages/error-messages.js';\n\n/**\n * Validador de comandos ZPL\n * Verifica: Comandos no soportados por Labelary, comandos deprecados\n */\nexport class CommandValidator implements IZplValidator {\n  type: ValidatorType = 'command';\n\n  // Comandos NO soportados o problematicos en Labelary\n  private readonly unsupportedCommands = [\n    '^JJ', // Configuracion de pausa\n    '^JM', // Cambio de unidades (puede funcionar pero mejor evitar)\n    '^JU', // Configuracion guardada\n    '^MN', // Modo de impresion\n    '^PR', // Velocidad de impresion\n    '^PW', // Ancho de impresion (usar tamaÃ±o de etiqueta en su lugar)\n    '^MD', // Densidad de impresion\n    '^MT', // Tipo de medio\n    '^MM', // Modo de impresion\n    '^MU', // Unidades de medida\n    '^JZ', // Reimprimir despues de error\n    '^NC', // Numero de copias (usar ^PQ)\n    '^NI', // ID de red\n    '^NN', // Nombre de red\n  ];\n\n  // Comandos deprecados (warning)\n  private readonly deprecatedCommands = [\n    '^A@', // Usar ^A0 en su lugar\n  ];\n\n  // Fuentes validas en Labelary\n  private readonly validFonts = [\n    '0',\n    'A',\n    'B',\n    'C',\n    'D',\n    'E',\n    'F',\n    'G',\n    'H',\n    'P',\n    'Q',\n    'R',\n    'S',\n    'T',\n    'U',\n    'V',\n  ];\n\n  validate(block: string, options: ValidationOptions): ValidationIssue[] {\n    const issues: ValidationIssue[] = [];\n    const messages = getMessages(options.language);\n\n    // Extraer todos los comandos (empiezan con ^ o ~)\n    const commandPattern = /[\\^~]([A-Z][A-Z0-9]?)/g;\n    let match;\n\n    while ((match = commandPattern.exec(block)) !== null) {\n      const command = '^' + match[1];\n\n      // Verificar comandos no soportados\n      if (this.unsupportedCommands.some((c) => command.startsWith(c))) {\n        issues.push({\n          code: 'ZPL_CMD_001',\n          type: this.type,\n          severity: 'warning',\n          message: messages.unsupportedCommand(command),\n          position: match.index,\n          suggestion: messages.suggestRemoveCommand(command),\n          command,\n        });\n      }\n\n      // Verificar comandos deprecados\n      if (this.deprecatedCommands.some((c) => command.startsWith(c))) {\n        issues.push({\n          code: 'ZPL_CMD_002',\n          type: this.type,\n          severity: 'warning',\n          message: messages.deprecatedCommand(command),\n          position: match.index,\n          suggestion: messages.suggestAlternative(command),\n          command,\n        });\n      }\n    }\n\n    // Verificar ^GB (Graphic Box) tiene parametros validos\n    this.validateGraphicBox(block, issues, messages);\n\n    // Verificar ^CF (Change Font) tiene fuente valida\n    this.validateChangeFont(block, issues, messages);\n\n    return issues;\n  }\n\n  private validateGraphicBox(\n    block: string,\n    issues: ValidationIssue[],\n    messages: ReturnType<typeof getMessages>,\n  ): void {\n    // ^GBw,h,t,c,r - w=width, h=height, t=thickness, c=color, r=rounding\n    const gbPattern = /\\^GB(\\d+)?,?(\\d+)?/g;\n    let match;\n\n    while ((match = gbPattern.exec(block)) !== null) {\n      const width = match[1] ? parseInt(match[1], 10) : 0;\n      const height = match[2] ? parseInt(match[2], 10) : 0;\n\n      // Ambas dimensiones en 0 es invalido\n      if (width === 0 && height === 0) {\n        issues.push({\n          code: 'ZPL_CMD_003',\n          type: this.type,\n          severity: 'error',\n          message: messages.invalidGraphicBox,\n          position: match.index,\n          context: match[0],\n          suggestion: messages.suggestGBParams,\n          command: '^GB',\n        });\n      }\n    }\n  }\n\n  private validateChangeFont(\n    block: string,\n    issues: ValidationIssue[],\n    messages: ReturnType<typeof getMessages>,\n  ): void {\n    // ^CFf,h,w - f=font, h=height, w=width\n    const cfPattern = /\\^CF([A-Z0-9])?/g;\n    let match;\n\n    while ((match = cfPattern.exec(block)) !== null) {\n      const font = match[1];\n\n      if (font && !this.validFonts.includes(font)) {\n        issues.push({\n          code: 'ZPL_CMD_004',\n          type: this.type,\n          severity: 'warning',\n          message: messages.unknownFont(font),\n          position: match.index,\n          context: match[0],\n          suggestion: messages.suggestFonts,\n          command: '^CF',\n        });\n      }\n    }\n  }\n}\n"],"names":["getMessages","CommandValidator","validate","block","options","issues","messages","language","commandPattern","match","exec","command","unsupportedCommands","some","c","startsWith","push","code","type","severity","message","unsupportedCommand","position","index","suggestion","suggestRemoveCommand","deprecatedCommands","deprecatedCommand","suggestAlternative","validateGraphicBox","validateChangeFont","gbPattern","width","parseInt","height","invalidGraphicBox","context","suggestGBParams","cfPattern","font","validFonts","includes","unknownFont","suggestFonts"],"mappings":"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"}