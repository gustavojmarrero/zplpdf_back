{"version":3,"sources":["../../../../src/modules/zpl/validation/zpl-validator.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport {\n  IZplValidator,\n  ValidationResult,\n  ValidationOptions,\n  ValidationIssue,\n  ValidationSummary,\n  ValidatorType,\n} from './zpl-validation.types.js';\nimport { StructureValidator } from './validators/structure-validator.js';\nimport { FieldValidator } from './validators/field-validator.js';\nimport { PositionValidator } from './validators/position-validator.js';\nimport { BarcodeValidator } from './validators/barcode-validator.js';\nimport { CommandValidator } from './validators/command-validator.js';\nimport { ValidationMetricsService } from '../logging/validation-metrics.service.js';\n\n/**\n * Servicio principal de validacion ZPL\n * Orquesta todos los validadores y construye el resultado final\n */\n@Injectable()\nexport class ZplValidatorService {\n  private readonly logger = new Logger(ZplValidatorService.name);\n  private readonly validators: IZplValidator[] = [];\n\n  constructor(private readonly metricsService: ValidationMetricsService) {\n    // Registrar validadores en orden de ejecucion\n    this.validators = [\n      new StructureValidator(),\n      new FieldValidator(),\n      new PositionValidator(),\n      new BarcodeValidator(),\n      new CommandValidator(),\n    ];\n  }\n\n  /**\n   * Valida contenido ZPL completo\n   * @param zplContent Contenido ZPL a validar\n   * @param options Opciones de validacion\n   * @returns Resultado de validacion con errores, warnings e info\n   */\n  async validate(\n    zplContent: string,\n    options: ValidationOptions = { language: 'es' },\n  ): Promise<ValidationResult> {\n    const startTime = Date.now();\n    const allIssues: ValidationIssue[] = [];\n\n    // 1. Extraer bloques ZPL\n    const blocks = this.extractBlocks(zplContent);\n\n    if (blocks.length === 0) {\n      // Si no hay bloques, verificar si hay contenido ZPL parcial\n      const hasPartialZpl =\n        zplContent.includes('^XA') || zplContent.includes('^XZ');\n\n      if (hasPartialZpl) {\n        allIssues.push({\n          code: 'ZPL_STRUCT_000',\n          type: 'structure',\n          severity: 'error',\n          message:\n            options.language === 'es'\n              ? 'No se encontraron etiquetas ZPL completas (^XA...^XZ)'\n              : 'No complete ZPL labels found (^XA...^XZ)',\n          suggestion:\n            options.language === 'es'\n              ? 'Verifique que cada etiqueta tenga ^XA al inicio y ^XZ al final'\n              : 'Verify each label has ^XA at start and ^XZ at end',\n        });\n      }\n    }\n\n    // 2. Ejecutar cada validador en cada bloque\n    for (const [blockIndex, block] of blocks.entries()) {\n      const blockIssues = this.validateBlock(block, blockIndex, options);\n      allIssues.push(...blockIssues);\n\n      // Limitar errores por bloque si se especifica\n      if (options.maxErrorsPerBlock) {\n        const blockErrors = blockIssues.filter((i) => i.severity === 'error');\n        if (blockErrors.length > options.maxErrorsPerBlock) {\n          break;\n        }\n      }\n    }\n\n    // 3. Clasificar y construir resultado\n    const result = this.buildResult(allIssues, blocks.length, options);\n\n    // 4. Registrar metricas\n    const duration = Date.now() - startTime;\n    this.metricsService\n      .recordValidation({\n        duration,\n        blockCount: blocks.length,\n        errors: result.errors,\n        warnings: result.warnings,\n      })\n      .catch((err) =>\n        this.logger.error(`Error registrando metricas: ${err.message}`),\n      );\n\n    this.logger.log(\n      `Validacion completada: ${blocks.length} bloques, ${result.errors.length} errores, ${result.warnings.length} warnings (${duration}ms)`,\n    );\n\n    return result;\n  }\n\n  /**\n   * Valida un solo bloque ZPL\n   */\n  private validateBlock(\n    block: string,\n    blockIndex: number,\n    options: ValidationOptions,\n  ): ValidationIssue[] {\n    const issues: ValidationIssue[] = [];\n\n    for (const validator of this.validators) {\n      // Saltar validadores si se especifica en opciones\n      if (options.skipValidators?.includes(validator.type)) {\n        continue;\n      }\n\n      try {\n        const validatorIssues = validator.validate(block, options);\n\n        // Agregar contexto del bloque a cada issue\n        issues.push(\n          ...validatorIssues.map((issue) => ({\n            ...issue,\n            context: issue.context || this.getContext(block, issue.position),\n            line: this.getLineNumber(block, issue.position),\n          })),\n        );\n      } catch (error) {\n        this.logger.error(\n          `Error en validador ${validator.type}: ${error.message}`,\n        );\n      }\n    }\n\n    return issues;\n  }\n\n  /**\n   * Extrae bloques ZPL del contenido (^XA...^XZ)\n   */\n  private extractBlocks(zpl: string): string[] {\n    const blocks = zpl.match(/\\^XA[\\s\\S]*?\\^XZ/g) || [];\n    return blocks;\n  }\n\n  /**\n   * Obtiene contexto alrededor de una posicion\n   */\n  private getContext(block: string, position?: number): string {\n    if (position === undefined) return '';\n    const start = Math.max(0, position - 15);\n    const end = Math.min(block.length, position + 25);\n    let context = block.slice(start, end);\n\n    if (start > 0) context = '...' + context;\n    if (end < block.length) context = context + '...';\n\n    return context.replace(/[\\r\\n]+/g, ' ');\n  }\n\n  /**\n   * Calcula el numero de linea aproximado\n   */\n  private getLineNumber(block: string, position?: number): number | undefined {\n    if (position === undefined) return undefined;\n    const beforePosition = block.substring(0, position);\n    const lines = beforePosition.split(/\\r?\\n/);\n    return lines.length;\n  }\n\n  /**\n   * Construye el resultado final de validacion\n   */\n  private buildResult(\n    issues: ValidationIssue[],\n    totalBlocks: number,\n    options: ValidationOptions,\n  ): ValidationResult {\n    const errors = issues.filter((i) => i.severity === 'error');\n    const warnings = issues.filter((i) => i.severity === 'warning');\n    const info = issues.filter((i) => i.severity === 'info');\n\n    // En modo estricto, warnings tambien invalidan\n    const isValid = options.strictMode\n      ? errors.length === 0 && warnings.length === 0\n      : errors.length === 0;\n\n    // Calcular bloques validos (sin errores)\n    const blocksWithErrors = new Set(\n      errors.map((e) => e.line).filter((l) => l !== undefined),\n    ).size;\n\n    return {\n      isValid,\n      errors,\n      warnings,\n      info,\n      summary: {\n        totalBlocks,\n        validBlocks: Math.max(0, totalBlocks - blocksWithErrors),\n        errorCount: errors.length,\n        warningCount: warnings.length,\n        infoCount: info.length,\n        validatorResults: this.getValidatorResults(issues),\n      },\n      processedAt: new Date(),\n    };\n  }\n\n  /**\n   * Obtiene resultados por validador\n   */\n  private getValidatorResults(\n    issues: ValidationIssue[],\n  ): Record<ValidatorType, boolean> {\n    const types: ValidatorType[] = [\n      'structure',\n      'field',\n      'position',\n      'barcode',\n      'command',\n    ];\n\n    return types.reduce(\n      (acc, type) => {\n        const hasErrors = issues.some(\n          (i) => i.type === type && i.severity === 'error',\n        );\n        acc[type] = !hasErrors;\n        return acc;\n      },\n      {} as Record<ValidatorType, boolean>,\n    );\n  }\n}\n"],"names":["Injectable","Logger","StructureValidator","FieldValidator","PositionValidator","BarcodeValidator","CommandValidator","ValidationMetricsService","ZplValidatorService","validate","zplContent","options","language","startTime","Date","now","allIssues","blocks","extractBlocks","length","hasPartialZpl","includes","push","code","type","severity","message","suggestion","blockIndex","block","entries","blockIssues","validateBlock","maxErrorsPerBlock","blockErrors","filter","i","result","buildResult","duration","metricsService","recordValidation","blockCount","errors","warnings","catch","err","logger","error","log","issues","validator","validators","skipValidators","validatorIssues","map","issue","context","getContext","position","line","getLineNumber","zpl","match","undefined","start","Math","max","end","min","slice","replace","beforePosition","substring","lines","split","totalBlocks","info","isValid","strictMode","blocksWithErrors","Set","e","l","size","summary","validBlocks","errorCount","warningCount","infoCount","validatorResults","getValidatorResults","processedAt","types","reduce","acc","hasErrors","some","constructor","name"],"mappings":"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"}