{"version":3,"sources":["../../../../src/modules/zpl/logging/validation-metrics.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { FirestoreService } from '../../cache/firestore.service.js';\nimport {\n  ValidationIssue,\n  ValidationMetrics,\n} from '../validation/zpl-validation.types.js';\n\n/**\n * Servicio de metricas para validacion ZPL\n * Registra errores frecuentes y patrones para analisis\n */\n@Injectable()\nexport class ValidationMetricsService {\n  private readonly logger = new Logger(ValidationMetricsService.name);\n  private readonly COLLECTION_NAME = 'validation_metrics';\n\n  constructor(private readonly firestoreService: FirestoreService) {}\n\n  /**\n   * Registra una validacion y sus resultados\n   */\n  async recordValidation(data: {\n    duration: number;\n    blockCount: number;\n    errors: ValidationIssue[];\n    warnings: ValidationIssue[];\n  }): Promise<void> {\n    try {\n      // Agrupar errores por codigo\n      const errorCounts = this.countByCodes(data.errors);\n      const warningCounts = this.countByCodes(data.warnings);\n\n      // Log estructurado para analisis\n      this.logger.log({\n        event: 'zpl_validation',\n        duration_ms: data.duration,\n        block_count: data.blockCount,\n        error_count: data.errors.length,\n        warning_count: data.warnings.length,\n        error_types: errorCounts,\n        warning_types: warningCounts,\n      });\n\n      // Guardar metricas agregadas en Firestore\n      await this.saveAggregatedMetrics(\n        data.duration,\n        data.blockCount,\n        errorCounts,\n        warningCounts,\n      );\n    } catch (error) {\n      this.logger.error(`Error registrando metricas: ${error.message}`);\n    }\n  }\n\n  /**\n   * Cuenta ocurrencias por codigo de error/warning\n   */\n  private countByCodes(issues: ValidationIssue[]): Record<string, number> {\n    return issues.reduce(\n      (acc, issue) => {\n        acc[issue.code] = (acc[issue.code] || 0) + 1;\n        return acc;\n      },\n      {} as Record<string, number>,\n    );\n  }\n\n  /**\n   * Guarda metricas agregadas diarias en Firestore\n   */\n  private async saveAggregatedMetrics(\n    duration: number,\n    blockCount: number,\n    errorCounts: Record<string, number>,\n    warningCounts: Record<string, number>,\n  ): Promise<void> {\n    const today = new Date().toISOString().split('T')[0];\n    const docId = `metrics_${today}`;\n\n    try {\n      const db = this.firestoreService.getDb();\n      const docRef = db.collection(this.COLLECTION_NAME).doc(docId);\n      const doc = await docRef.get();\n\n      if (doc.exists) {\n        // Actualizar metricas existentes\n        const existing = doc.data() as ValidationMetrics;\n\n        // Merge error counts\n        const mergedErrors = { ...existing.errorCounts };\n        for (const [code, count] of Object.entries(errorCounts)) {\n          mergedErrors[code] = (mergedErrors[code] || 0) + count;\n        }\n\n        // Merge warning counts\n        const mergedWarnings = { ...existing.warningCounts };\n        for (const [code, count] of Object.entries(warningCounts)) {\n          mergedWarnings[code] = (mergedWarnings[code] || 0) + count;\n        }\n\n        // Calcular promedio de duracion\n        const newTotalValidations = existing.totalValidations + 1;\n        const newAvgDuration = Math.round(\n          (existing.avgDurationMs * existing.totalValidations + duration) /\n            newTotalValidations,\n        );\n\n        await docRef.update({\n          totalValidations: newTotalValidations,\n          totalBlocks: existing.totalBlocks + blockCount,\n          errorCounts: mergedErrors,\n          warningCounts: mergedWarnings,\n          avgDurationMs: newAvgDuration,\n          updatedAt: new Date(),\n        });\n      } else {\n        // Crear nuevo documento de metricas\n        const metrics: ValidationMetrics = {\n          date: today,\n          totalValidations: 1,\n          totalBlocks: blockCount,\n          errorCounts,\n          warningCounts,\n          avgDurationMs: duration,\n          updatedAt: new Date(),\n        };\n\n        await docRef.set(metrics);\n      }\n    } catch (error) {\n      this.logger.error(`Error guardando metricas en Firestore: ${error.message}`);\n    }\n  }\n\n  /**\n   * Obtiene tendencias de errores de los ultimos N dias\n   */\n  async getErrorTrends(days: number = 30): Promise<{\n    mostCommonErrors: Array<{ code: string; count: number; description: string }>;\n    errorsByDay: Array<{ date: string; count: number }>;\n  }> {\n    try {\n      const db = this.firestoreService.getDb();\n      const startDate = new Date();\n      startDate.setDate(startDate.getDate() - days);\n      const startDateStr = startDate.toISOString().split('T')[0];\n\n      const snapshot = await db\n        .collection(this.COLLECTION_NAME)\n        .where('date', '>=', startDateStr)\n        .orderBy('date', 'desc')\n        .get();\n\n      const aggregatedErrors: Record<string, number> = {};\n      const errorsByDay: Array<{ date: string; count: number }> = [];\n\n      snapshot.forEach((doc) => {\n        const data = doc.data() as ValidationMetrics;\n\n        // Agregar errores por dia\n        const dayErrorCount = Object.values(data.errorCounts).reduce(\n          (sum, count) => sum + count,\n          0,\n        );\n        errorsByDay.push({ date: data.date, count: dayErrorCount });\n\n        // Agregar al total\n        for (const [code, count] of Object.entries(data.errorCounts)) {\n          aggregatedErrors[code] = (aggregatedErrors[code] || 0) + count;\n        }\n      });\n\n      // Ordenar errores por frecuencia\n      const mostCommonErrors = Object.entries(aggregatedErrors)\n        .map(([code, count]) => ({\n          code,\n          count,\n          description: this.getErrorDescription(code),\n        }))\n        .sort((a, b) => b.count - a.count)\n        .slice(0, 10);\n\n      return {\n        mostCommonErrors,\n        errorsByDay: errorsByDay.sort(\n          (a, b) => new Date(a.date).getTime() - new Date(b.date).getTime(),\n        ),\n      };\n    } catch (error) {\n      this.logger.error(`Error obteniendo tendencias: ${error.message}`);\n      return { mostCommonErrors: [], errorsByDay: [] };\n    }\n  }\n\n  /**\n   * Obtiene descripcion de un codigo de error\n   */\n  private getErrorDescription(code: string): string {\n    const descriptions: Record<string, string> = {\n      ZPL_STRUCT_000: 'No se encontraron etiquetas completas',\n      ZPL_STRUCT_001: 'Falta ^XA',\n      ZPL_STRUCT_002: 'Falta ^XZ',\n      ZPL_STRUCT_003: 'Multiples ^XA',\n      ZPL_STRUCT_004: 'Multiples ^XZ',\n      ZPL_FIELD_001: 'Desequilibrio ^FD/^FS',\n      ZPL_FIELD_002: 'Campo vacio',\n      ZPL_FIELD_003: '^FD sin posicion',\n      ZPL_POS_001: '^FO sin coordenadas',\n      ZPL_POS_002: 'Coordenadas negativas',\n      ZPL_POS_003: 'Coordenadas muy grandes',\n      ZPL_POS_004: '^FT sin coordenadas',\n      ZPL_BC_001: 'Codigo de barras no soportado',\n      ZPL_BC_002: 'Orientacion invalida',\n      ZPL_BC_003: 'Modelo QR invalido',\n      ZPL_BC_004: 'Ancho de barra invalido',\n      ZPL_BC_005: 'Codigo de barras sin datos',\n      ZPL_CMD_001: 'Comando no soportado',\n      ZPL_CMD_002: 'Comando deprecado',\n      ZPL_CMD_003: 'Caja grafica invalida',\n      ZPL_CMD_004: 'Fuente desconocida',\n    };\n\n    return descriptions[code] || code;\n  }\n}\n"],"names":["Injectable","Logger","FirestoreService","ValidationMetricsService","recordValidation","data","errorCounts","countByCodes","errors","warningCounts","warnings","logger","log","event","duration_ms","duration","block_count","blockCount","error_count","length","warning_count","error_types","warning_types","saveAggregatedMetrics","error","message","issues","reduce","acc","issue","code","today","Date","toISOString","split","docId","db","firestoreService","getDb","docRef","collection","COLLECTION_NAME","doc","get","exists","existing","mergedErrors","count","Object","entries","mergedWarnings","newTotalValidations","totalValidations","newAvgDuration","Math","round","avgDurationMs","update","totalBlocks","updatedAt","metrics","date","set","getErrorTrends","days","startDate","setDate","getDate","startDateStr","snapshot","where","orderBy","aggregatedErrors","errorsByDay","forEach","dayErrorCount","values","sum","push","mostCommonErrors","map","description","getErrorDescription","sort","a","b","slice","getTime","descriptions","ZPL_STRUCT_000","ZPL_STRUCT_001","ZPL_STRUCT_002","ZPL_STRUCT_003","ZPL_STRUCT_004","ZPL_FIELD_001","ZPL_FIELD_002","ZPL_FIELD_003","ZPL_POS_001","ZPL_POS_002","ZPL_POS_003","ZPL_POS_004","ZPL_BC_001","ZPL_BC_002","ZPL_BC_003","ZPL_BC_004","ZPL_BC_005","ZPL_CMD_001","ZPL_CMD_002","ZPL_CMD_003","ZPL_CMD_004","constructor","name"],"mappings":"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"}